{% extends "Base.html" %}
{% block title %}Playlists{% endblock %}
{% block content %}
  <main class="page playlists-page">
    <section class="playlists-content" aria-labelledby="playlists-heading">
      {% set user_display_name = spotify_profile.display_name if spotify_profile and spotify_profile.display_name else "Guest" %}
      {% set avatar_initial = user_display_name[0] if user_display_name else "?" %}
      <header class="playlists-toolbar">
        <div class="playlists-title-group">
          <h1 id="playlists-heading" class="playlists-title">Playlists</h1>
          <p class="playlists-subtitle">Your saved mixes and favorite collections</p>
        </div>
        <div class="playlists-toolbar-actions">
          <button id="upload-trigger" class="icon-btn icon-btn-primary" type="button" aria-label="Create playlist">+</button>
          <button class="playlists-username" type="button" aria-label="Account menu">
            <span class="playlists-avatar">{{ avatar_initial|upper }}</span>
            <span class="playlists-username-label">{{ user_display_name }}</span>
          </button>
        </div>
      </header>

      <div class="playlist-grid">
        {% if user_playlists %}
          {% for playlist in user_playlists %}
        <a class="playlist-card" href="#" aria-label="Open {{ playlist.name }}" data-playlist-id="{{ playlist.id }}">
          <div class="playlist-cover" {% if playlist.cover_image %}style="background-image: url('{{ playlist.cover_image }}'); background-size: cover; background-position: center;"{% endif %}>
            {% if not playlist.cover_image %}
            <span class="playlist-cover-chip">{{ playlist.name[:30] }}{% if playlist.name|length > 30 %}...{% endif %}</span>
            {% endif %}
          </div>
          <div class="playlist-info">
            <h2 class="playlist-name">{{ playlist.name }}</h2>
            <p class="playlist-meta">{{ playlist.song_count }} track{{ 's' if playlist.song_count != 1 else '' }}</p>
          </div>
        </a>
          {% endfor %}
        {% else %}
        <div class="playlist-card playlist-card-empty" style="grid-column: 1 / -1; text-align: center;">
          <div class="playlist-cover">
            <span class="playlist-cover-chip">No playlists yet</span>
          </div>
          <div class="playlist-info">
            <h2 class="playlist-name">Create Your First Playlist</h2>
            <p class="playlist-meta">Click the + button above to upload an image and generate a playlist!</p>
          </div>
        </div>
        {% endif %}

        <!-- Add new playlist card -->
        <a class="playlist-card playlist-card-empty" href="#" aria-label="Create a new playlist from photo" id="new-playlist-card">
          <div class="playlist-cover">
            <span class="playlist-cover-chip">Drop a new photo</span>
          </div>
          <div class="playlist-info">
            <h2 class="playlist-name">New playlist</h2>
            <p class="playlist-meta">Turn your next picture into a mix.</p>
          </div>
        </a>

      </div>

      <footer class="playlists-footer-hint" aria-hidden="true">
        <span class="playlists-footer-gradient"></span>
        <span class="playlists-footer-text">Scroll for more playlists</span>
      </footer>
    </section>
  </main>
  <input id="image-upload-input" type="file" accept="image/*" hidden>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const uploadBtn = document.getElementById('upload-trigger');
    const fileInput = document.getElementById('image-upload-input');
    const grid = document.querySelector('.playlist-grid');

    function setLoading(isLoading) {
      if (!uploadBtn) return;
      uploadBtn.disabled = isLoading;
      uploadBtn.textContent = isLoading ? '...' : '+';
    }

    function createCard(data) {
      const card = document.createElement('a');
      card.className = 'playlist-card';
      card.href = '#';
      card.setAttribute('aria-label', `Open ${data.playlist_name || 'playlist'}`);
      card.style.setProperty('--playlist-accent', '#1db954');

      const cover = document.createElement('div');
      cover.className = 'playlist-cover';
      const chip = document.createElement('span');
      chip.className = 'playlist-cover-chip';
      chip.textContent = (data.descriptors || []).slice(0, 3).join(' â€¢ ') || 'New mix';
      cover.appendChild(chip);

      const info = document.createElement('div');
      info.className = 'playlist-info';
      const nameEl = document.createElement('h2');
      nameEl.className = 'playlist-name';
      nameEl.textContent = data.playlist_name || 'Playlist';
      const meta = document.createElement('p');
      meta.className = 'playlist-meta';
      meta.textContent = `${data.track_count || 0} tracks`;

      info.appendChild(nameEl);
      info.appendChild(meta);

      card.appendChild(cover);
      card.appendChild(info);
      return card;
    }

    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      const response = await fetch('/api/playlists/from-image', {
        method: 'POST',
        body: formData,
      });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        const message = err.error || 'Failed to create playlist.';
        throw new Error(message);
      }
      return response.json();
    }

    if (uploadBtn && fileInput) {
      uploadBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', async () => {
        if (!fileInput.files || !fileInput.files.length) return;
        const file = fileInput.files[0];
        setLoading(true);
        try {
          const data = await uploadImage(file);
          // Reload page to show updated playlist from database
          window.location.reload();
        } catch (err) {
          alert(err.message || 'Could not create playlist.');
          setLoading(false);
          fileInput.value = '';
        }
      });
    }

    // Also allow clicking the "New playlist" card to upload
    const newPlaylistCard = document.getElementById('new-playlist-card');
    if (newPlaylistCard && fileInput) {
      newPlaylistCard.addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
      });
    }
  })();
</script>
{% endblock %}
